pipeline {
    agent { label 'asm-builder'}

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()           //ä¸å…è®¸å¹¶è¡Œæ„å»º
        timeout(time: 20, unit: 'MINUTES')  //è¶…æ—¶æ—¶é—´
        gitLabConnection('jenkins')          //gitlabæ’ä»¶è¿æ¥å™¨
    }


    environment {
        REGISTRY = "https://harbor.synsense-neuromorphic.com"
        IMAGE_REPO = "harbor.synsense-neuromorphic.com/local/asm"
 //       DINGTALK_CREDS = credentials('dingTalk')
        REGISTRY_CREDS = credentials('docker-user-pwd')
        TAB_STR = "\n                  \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
    }

    stages {
        stage('gitlog') {
            steps {
                script{
                    sh "git log --oneline -n 1 > gitlog.file"
                    env.GIT_LOG = readFile("gitlog.file").trim()
                }
                sh 'printenv'
            }
        }
        stage('checkout') {
            steps {  //åœ¨é»˜è®¤çš„ jnlp ,inbound-agent å®¹å™¨æ‰§è¡Œ
                checkout scm   // checkout ä»£ç 
                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                script{
                    env.BUILD_TASKS = env.STAGE_NAME + "âˆš..." + env.TAB_STR
                }
            }
        }
        stage('mvn package') {
            steps {
                container('ci-tools') {   //æŒ‡å®šåœ¨ ci-tools å®¹å™¨é‡Œæ‰§è¡Œ
                    sh 'mvn clean package -Dmaven.test.skip=true'  // mvn ç¼–è¯‘,è·³è¿‡æµ‹è¯•
                }
                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                script{
                    env.BUILD_TASKS += env.STAGE_NAME + "âˆš..." + env.TAB_STR
                }
            }
        }
        stage('build-image') {
            steps {
                container('ci-tools') {  //æŒ‡å®šåœ¨ ci-tools å®¹å™¨é‡Œæ‰§è¡Œ
                    retry(2) { sh 'docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}'}   //docker build
                }
                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                script{
                    env.BUILD_TASKS += env.STAGE_NAME + "âˆš..." + env.TAB_STR
                }
            }
        }
        stage('push-image') {
            steps {
                container('ci-tools') { //æŒ‡å®šåœ¨ ci-tools å®¹å™¨é‡Œæ‰§è¡Œ
                        retry(2) {
                            sh('docker login ${REGISTRY} -u ${REGISTRY_CREDS_USR} -p ${REGISTRY_CREDS_PSW}')
                            sh('docker push ${IMAGE_REPO}:${GIT_COMMIT}')

                        }
                }
                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                script{
                    env.BUILD_TASKS += env.STAGE_NAME + "âˆš..." + env.TAB_STR
                }
            }
        }
        stage('deploy') {
            steps {
                container('ci-tools') {
                    timeout(time: 1, unit: 'MINUTES') {
                        sh "sed -i 's#{{ELADMIN-IMAGE}}#${IMAGE_REPO}:${GIT_COMMIT}#g' manifest/*"  // ä¿®æ”¹pod yamlæ–‡ä»¶
                        sh "kubectl apply -f manifest/"   // å‘å¸ƒ pod
                    }
                }
                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                script{
                    env.BUILD_TASKS += env.STAGE_NAME + "âˆš..." + env.TAB_STR
                }
            }
        }
    }
    post {
        success {
            container('ci-tools') {
                echo 'Congratulations!'
                sh """
           //         curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \
           //             -H 'Content-Type: application/json' \
            //            -d '{
            //                "msgtype": "markdown",
            //                "markdown": {
           //                     "title":"myblog",
           //                     "text": "ğŸ˜„ğŸ‘ æ„å»ºæˆåŠŸ ğŸ‘ğŸ˜„  \n**é¡¹ç›®åç§°**: luffy  \n**Git log**: ${GIT_LOG}   \n**æ„å»ºåˆ†æ”¯**: ${GIT_BRANCH}   \n**æ„å»ºåœ°å€**: ${RUN_DISPLAY_URL}  \n**æ„å»ºä»»åŠ¡**: ${BUILD_TASKS}"
            //                }
            //            }'
                """
            }

        }
        failure {
            container('ci-tools') {
                echo 'Oh no!'
                sh """
                  //  curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \
                   //     -H 'Content-Type: application/json' \
                    //    -d '{
                     //       "msgtype": "markdown",
                      //      "markdown": {
                       //         "title":"myblog",
                        //        "text": "ğŸ˜–âŒ æ„å»ºå¤±è´¥ âŒğŸ˜–  \n**é¡¹ç›®åç§°**: luffy  \n**Git log**: ${GIT_LOG}   \n**æ„å»ºåˆ†æ”¯**: ${GIT_BRANCH}  \n**æ„å»ºåœ°å€**: ${RUN_DISPLAY_URL}  \n**æ„å»ºä»»åŠ¡**: ${BUILD_TASKS}"
                    //   }
                       // }'
                """
            }

        }
        always {
            echo 'I will always say Hello again!'
        }
    }
}
